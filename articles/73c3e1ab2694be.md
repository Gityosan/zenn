---
title: 'Vue3ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«çŠ¶æ³ã‚’å†ç¾ã™ã‚‹'
emoji: 'ğŸŒŠ'
type: 'tech'
topics: ['vue', 'vueHistoryState']
published: true
---

## ã¯ã˜ã‚ã«

vueã§ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Ÿè£…ã™ã‚‹ã¨ãã®ãƒšãƒ¼ã‚¸ã«æˆ»ã£ã¦ããŸæ™‚ã«ä»¥å‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸä½ç½®ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸçŠ¶æ…‹ã§è¡¨ç¤ºã—ãŸã„çŠ¶æ³ã«é­é‡ã—ã¾ã™ã€‚

## è¦ä»¶

ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«çŠ¶æ³ã®å†ç¾ã«éš›ã—ã¦è€ƒæ…®ã—ãŸã„ç‚¹ã¯ã€

- ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã£ã¦ããŸæ™‚ã«
  - å–å¾—å‡¦ç†ã®å®Œäº†ã‚’å¾…ã£ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†ã‚’è¡Œã†ã“ã¨
  - backã§æˆ»ã£ã¦ããŸã®ã‹ã€reloadã§æˆ»ã£ã¦ããŸã®ã‹ã€pushã§æˆ»ã£ã¦ããŸã®ã‹ã®åˆ¤åˆ¥

ã®ï¼’ç‚¹ã«ãªã‚Šã¾ã™ã€‚

## å®Ÿè£…

ä»Šå›`vue-history-state`ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã„ã¾ã—ãŸã€‚
ã„ã¤ã‚‚æœ‰é›£ãä½¿ã‚ã›ã¦é ‚ã„ã¦ãŠã‚Šã¾ã™m(\_ \_)m

https://github.com/hidekatsu-izuno/vue-history-state

ä½¿ã„æ–¹ã®è©³ç´°ã«ã¤ã„ã¦ã¯READMEã‚„ä½œè€…ã®æ–¹ã®è§£èª¬è¨˜äº‹ã‚’ã”å‚ç…§ä¸‹ã•ã„ã€‚

https://qiita.com/hidekatsu-izuno/items/8abad0c1bb559490d65b

ã¾ãšã€åˆæœŸåŒ–ã—ã¾ã™ã€‚

```typescript:main.ts
import { createApp } from 'vue';
import HistoryStatePlugin from 'vue-history-state';
const app = createApp();
app.use(HistoryStatePlugin, { maxHistoryLength: 5 });
```

é–¢é€£ã™ã‚‹å‡¦ç†ã‚’composablesã«ã¾ã¨ã‚ã¦åˆ‡ã‚Šå‡ºã—ã¾ã™ã€‚
`vue-history-state`ã®å¬‰ã—ã„ã¨ã“ã‚ã¯ã€çŠ¶æ…‹ã®ä¿å­˜å‡¦ç†ãŒé›¢è„±æ™‚ã«è¡Œã‚ã‚Œã‚‹ãŸã‚ã€å¿…è¦ãªå‡¦ç†ãŒè¤‡æ•°ãƒšãƒ¼ã‚¸ã«ã¾ãŸãŒã‚‹ã“ã¨ãªãç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Ÿè£…ã™ã‚‹ãƒšãƒ¼ã‚¸ã«ã®ã¿æ›¸ã‘ã°æ¸ˆã‚€ç‚¹ã§ã™ã€‚
ãã®ãŸã‚ã€ä¸€ã¤ã®composableã«ã¾ã¨ã‚ã‚‹ã“ã¨ã‚‚å®¹æ˜“ã«ãªã‚Šã¾ã—ãŸã€‚

å‡¦ç†ã®å¤§æ ã¨ã—ã¦ã¯ã€

1. é›¢è„±æ™‚ã«çŠ¶æ…‹ã‚’ä¿å­˜
2. æˆ»ã£ã¦ããŸæ™‚ã«`checkHistoryState`ã‚’å®Ÿè¡Œã—ã€çŠ¶æ…‹ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚Œã°`isComeback`ãƒ•ãƒ©ã‚°ã‚’`true`ã«ã™ã‚‹
3. ä¿å­˜ã•ã‚Œã¦ã„ãŸ`currentPage`ã¨`perPage`ã‚’å…ƒã«å¿…è¦ãªæ•°ã ã‘ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’APIã‹ã‚‰å–å¾—ã™ã‚‹
4. å–å¾—å®Œäº†å¾Œã«`restorePagerAndScroll`ã‚’å®Ÿè¡Œã—ã€`currentPage`ã¨`perPage`ã‚’æœ¬æ¥ã®æ•°ã«æˆ»ã™

ãªãŠã€ä»Šå›ã¯`push`ã§æˆ»ã£ã¦ããŸæ™‚ã¯å†ç¾ã•ã›ãšã€`back`ã¨`reload`ã§æˆ»ã£ã¦ããŸæ™‚ã®ã¿å†ç¾ã™ã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚

```typescript:composables/pager.ts
import { ref, onBeforeUnmount, Ref } from 'vue';
import { useHistoryState, onBackupState } from 'vue-history-state';

export function usePager(initialPerPage: number) {
  const isComeback = ref<boolean>(false);
  const interval = ref<number | null>(null);
  const currentPage = ref<number>(0);
  const perPageCount = ref<number>(0);
  const history = useHistoryState();
  const checkHistoryState = () => {
    if (history.action !== 'back' && history.action !== 'reload') return;
    if (!history.data) return;
    if (history.data.scrollY) isComeback.value = true;
    if (!Number(history.data.perPage) || !Number(history.data.currentPage)) return;
    currentPage.value = 1;
    perPageCount.value = history.data.perPage * history.data.currentPage;
  };
  const restorePagerAndScroll = () => {
    if (!isComeback.value) return;
    isComeback.value = false;
    currentPage.value = Math.ceil(perPageCount.value / initialPerPage);
    perPageCount.value = initialPerPage;
    interval.value = window.setInterval(() => {
      if (
        history.data?.scrollY &&
        window.document.documentElement.scrollHeight >= history.data?.scrollY
      ) {
        window.scrollTo(0, history.data?.scrollY);
        if (interval.value) window.clearInterval(interval.value);
        history.data = {};
      }
    }, 100);
  };
  onBackupState(() => ({
    ...(history.data || {}),
    scrollY: window.scrollY,
    currentPage: currentPage.value,
    perPage: perPageCount.value,
  }));
  onBeforeUnmount(() => {
    if (interval.value) window.clearInterval(interval.value);
  });

  return {
    currentPage,
    perPageCount,
    checkHistoryState,
    restorePagerAndScroll,
  };
}
```

ä¸‹è¨˜ã®ã‚ˆã†ã«å‘¼ã³å‡ºã—ã¾ã™ã€‚

```vue:some-list.vue
<script setup lang="ts">
import { usePager } from '@/composables/pager';
const items = ref<any[]>([])
// ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯ä¸€åº¦ã®å–å¾—ã§16ä»¶ãšã¤å–å¾—ã™ã‚‹ã¨ã™ã‚‹
const initialPerPage = 16;
const { checkHistoryState, restorePagerAndScroll } = usePager(initialPerPage);
const apiFetch = async () => {
  await fetch('~').then((res) => {
    items.value.push(...res)
    restorePagerAndScroll();
  });
};
onMounted(() => {
  checkHistoryState();
});
</script>
<template>
 <some-list :items="items" @refetch="apiFetch"/>
</template>
```

### çµ‚ã‚ã‚Šã«

ä»Šå›ã¯ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«ãŠã„ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«çŠ¶æ³ã®å†ç¾ã«`vue-history-state`ã‚’ä½¿ã„ã¾ã—ãŸãŒã€ä¿å­˜ã™ã‚‹å€¤ã¯ãªã‚“ã§ã‚‚è‰¯ã„ãŸã‚ä»–ã«ã‚‚è‰²ã‚“ãªçŠ¶æ³ã«ãŠã„ã¦viewã®çŠ¶æ³ã‚’å¾©å…ƒã™ã‚‹ãŸã‚ã®ç”¨é€”ã«ä½¿ãˆã¾ã™ã€‚

nextç”¨ã®`next-navigation-history`ã‚‚ã‚ã‚‹ãã†ãªã®ã§ã€ã‚ˆã‹ã£ãŸã‚‰çš†ã•ã‚“ã‚‚ä½¿ã£ã¦ã¿ã¦ãã ã•ã„

https://github.com/hidekatsu-izuno/next-navigation-history
