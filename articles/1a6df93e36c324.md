---
title: 'Vue3 provide/injectçŠ¶æ…‹ç®¡ç†æ™‚ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ãƒ¼ãƒ‰åˆ¶å¾¡Tips'
emoji: 'ğŸ“š'
type: 'tech'
topics: ['vue3', 'vueRouter']
published: true
---

# ä½•ã®è¨˜äº‹ã‹

- Vue3ã§provide/injectã‚’ç”¨ã„ãŸçŠ¶æ…‹ç®¡ç†ã‚’è¡Œãªã£ã¦ã„ã‚‹å ´åˆã€vue-routerã®`router.beforeEach`ãƒ•ãƒƒã‚¯å†…ã§çŠ¶æ…‹ç®¡ç†ã—ã¦ã„ã‚‹çŠ¶æ…‹ã‚’å‚ç…§ã™ã‚‹ã¨ã€`undefined`ãŒè¿”ã£ã¦ãã¦ã—ã¾ã†
- ãã®ãŸã‚ã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ãƒ¼ãƒ‰ã‚’åˆ¶å¾¡ã™ã‚‹å ´åˆã€`router.beforeEach`ä»¥å¤–ã§åˆ¶å¾¡ã™ã‚‹ã‚ˆã†ã«å·¥å¤«ãŒå¿…è¦

# å‰æã¨ã™ã‚‹ç’°å¢ƒ

ä¾‹ãˆã°ä¸‹è¨˜ã®ã‚ˆã†ãªvueç’°å¢ƒãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

```typescript:main.ts
import { createApp } from 'vue';
import router from './router';
import { keyMyUser, createDefaultMyUser } from './state';
const app = createApp();
app.use(router);
app.provide(keyMyUser, createDefaultMyUser());
app.mount('#app');
```

```typescript:router.ts
import { createRouter, createWebHistory, Router, RouteLocationNormalized } from 'vue-router';
import { useMyUser } from './state';
import { routes } from './routes';

// navigation guard é–¢æ•°
export const navigationGuard = async (
  to: RouteLocationNormalized,
  from: RouteLocationNormalized,
) => {
  const myUser = useMyUser() // â† ã“ã“ãŒå•é¡Œ undefinedã‚’è¿”ã—ã¦ã—ã¾ã†
  if (myUser) {
    // <ä¸­ç•¥>
  } else return '/login'
}

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes,
});
router.beforeEach(navigationGuard);
export default router;
```

ã“ã®`router.ts`å†…ã®`router.beforeEach(navigationGuard)`ã§è¨­å®šã—ãŸ`navigationGuard`é–¢æ•°å†…ã§å‚ç…§ã—ãŸ`useMyUser()`ãŒ`undefined`ã‚’è¿”ã—ã¦ã—ã¾ã„ã€æ­£ã—ããƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®åˆ¶å¾¡ã‚’ã™ã‚‹ã®ãŒé›£ã—ã„

# å¯¾å¿œç­–

ã¾ãš`useMyUser()`ãŒ`undefined`ã‚’è¿”ã•ãšæ­£ã—ãå€¤ã‚’è¿”ã™ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«`script setup`ã¾ãŸã¯`setup()`ã®ä¸­ã§`navigationGuard`ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

> ç¹°ã‚Šè¿”ã—ã¾ã™ãŒã€ã‚‚ã— <script setup> ã‚’ä½¿ç”¨ã—ãªã„ã®ã§ã‚ã‚Œã°ã€inject() ã¯ setup() ã®å†…éƒ¨ã§ã®ã¿åŒæœŸçš„ã«å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™:
> https://ja.vuejs.org/guide/components/provide-inject.html#inject

`app.vue`ã§`router.beforeEach`ã®ä»£ã‚ã‚Šã«`watch(router.currentRoute,() => {})`ã‚’ä½¿ã£ã¦routeã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã¾ã™ã€‚

åŠ ãˆã¦ã€`myUser`ã‚’`router.ts`å†…ã§importã—ãŸ`useMyUser`ã‹ã‚‰å–å¾—ã™ã‚‹ã®ã§ã¯ãªãã€å¼•æ•°ã§å—ã‘å–ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```vue:app.vue
<template>
  <router-view />
</template>
<script setup lang="ts">
import { watch } from 'vue';
import { useRouter } from 'vue-router';
import { navigationGuard } from './router';
const router = useRouter();
watch(router.currentRoute, async (newValue, oldValue) => {
  const redirectPath = await navigationGuard(
    newValue.path,
    oldValue.path,
  );
  if (redirectPath) router.push(redirectPath);
});
</script>
```

```typescript:router.ts
// <ä¸­ç•¥>
import type { MyUser } from './state';

// navigation guard é–¢æ•°
export const navigationGuard = async (
  to: RouteLocationNormalized,
  from: RouteLocationNormalized,
  myUser?: MyUser
) => {
  if (myUser) {
    // <ä¸­ç•¥>
  } else return '/login'
}
// <ä¸­ç•¥>
```

# æ³¨æ„ç‚¹

äºŒã¤ã»ã©æ³¨æ„ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

1. `navigationGuard`ã§é·ç§»ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒ**é·ç§»å‰**ã‹ã‚‰**é·ç§»å¾Œ**ã«å¤‰ã‚ã£ã¦ã„ã‚‹
2. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ™‚ã€çµŒç”±ã™ã‚‹ãƒ«ãƒ¼ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒå®Ÿè¡Œã•ã‚Œã¦ã—ã¾ã†
   - ä¾‹ãˆã°ã€æœªãƒ­ã‚°ã‚¤ãƒ³ã§`/`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã—ã¦`/login`ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚ŒãŸå ´åˆã€ä¸Šè¨˜å‡¦ç†ã§ã¯ä¸€ç¬`/`ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒå§‹ã¾ã£ã¦è¡¨ç¤ºã•ã‚Œã¦ã—ã¾ã†
   - åŠ ãˆã¦ã€createdã‚„onMountedãªã©ã«å®šç¾©ã—ãŸå–å¾—å‡¦ç†ãªã©ã‚‚èµ°ã£ã¦ã—ã¾ã„ä½™è¨ˆãªã‚¨ãƒ©ãƒ¼ã‚’ç”Ÿã¿å‡ºã—ã¦ã—ã¾ã†

## 1. é·ç§»ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒ**é·ç§»å‰**ã‹ã‚‰**é·ç§»å¾Œ**ã«å¤‰ã‚ã£ã¦ã„ã‚‹

ã“ã‚Œã§ç‰¹æ®µ`navigationGuard`ã®å‡¦ç†ãŒå¤‰ã‚ã‚‹ã¨ã„ã†ã“ã¨ã§ã¯ãªã„ã‚“ã§ã™ãŒã€æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

## 2. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ™‚ã€çµŒç”±ã™ã‚‹ãƒ«ãƒ¼ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒå®Ÿè¡Œã•ã‚Œã¦ã—ã¾ã†

ä¸‹è¨˜ã®ã‚ˆã†ã«ãƒ«ãƒ¼ãƒˆãŒå¤‰æ›´ã—ãŸéš›ã«`redirectPath`ãŒfalcyã€ã¤ã¾ã‚Šã‚‚ã†ã“ã‚Œä»¥ä¸Šãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹å¿…è¦ãŒãªã„ã¨ãã«`readyForDisplay`ã‚’`true`ã«ã™ã‚‹ã“ã¨ã§ã€ãã‚Œã¾ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒèµ°ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```vue:app.vue
<template>
  <router-view v-if="readyForDisplay"/>
</template>
<script setup lang="ts">
import { ref, watch } from 'vue';
import { useRouter } from 'vue-router';
import { navigationGuard } from './router';
import { useMyUser } from './state';
const router = useRouter();
const readyForDisplay = ref<boolean>(false);
const myUser = useMyUser()
watch(router.currentRoute, async (newValue, oldValue) => {
  const redirectPath = await navigationGuard(
    newValue.path,
    oldValue.path,
    myUser.value,
  );
  if (redirectPath) router.push(redirectPath);
  else readyForDisplay.value = true
});
</script>
```

ã“ã‚Œã‹ã‚‰vueã§ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã™ã‚‹éš›ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
